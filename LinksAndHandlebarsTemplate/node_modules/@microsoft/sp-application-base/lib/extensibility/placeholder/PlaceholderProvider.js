import { _LogSource, _TraceLogger } from '@microsoft/sp-diagnostics';
import { _QosMonitor } from '@ms/sp-telemetry';
import PlaceholderManager from './PlaceholderManager';
var PlaceholderProvider = (function () {
    function PlaceholderProvider(serviceScope, sequence) {
        var _this = this;
        this._placeholders = undefined;
        this._sequence = sequence;
        serviceScope.whenFinished(function () {
            _this._placeholderManager = serviceScope.consume(PlaceholderManager.serviceKey);
        });
    }
    PlaceholderProvider.prototype.tryCreateContent = function (name, options) {
        _TraceLogger.logVerbose(PlaceholderProvider._logSource, "Creating placeholder content in placeholder \"" + name + "\"");
        var qosMonitor = new _QosMonitor('Placeholder.tryCreateContent');
        if (!this._tryInitialize() || !this._placeholders.has(name)) {
            var error = new Error("No placeholder found with the name '" + name + "'");
            qosMonitor.writeExpectedFailure('PlaceholderNotFound', error, { name: name });
            return undefined;
        }
        var placeholder = this._placeholders.get(name);
        if (!placeholder) {
            var error = new Error('Placeholder dictionary has only the key but not the value for the placeholder');
            qosMonitor.writeUnexpectedFailure('NoValueInPlaceholdersMap', error, { name: name });
            return undefined;
        }
        var content;
        try {
            content = placeholder.createPlaceholderContent(this._sequence, options);
        }
        catch (error) {
            qosMonitor.writeUnexpectedFailure('CreateContentFailed', error, { name: name });
            return undefined;
        }
        if (content) {
            qosMonitor.writeSuccess({ name: name });
        }
        else {
            var error = new Error('Placeholder could not create new content');
            qosMonitor.writeUnexpectedFailure('CreateContentUndefined', error, { name: name });
        }
        return content;
    };
    Object.defineProperty(PlaceholderProvider.prototype, "placeholderNames", {
        get: function () {
            if (!this._tryInitialize()) {
                return [];
            }
            var array = [];
            if (this._placeholders) {
                this._placeholders.forEach(function (value, key) {
                    if (key) {
                        array.push(key);
                    }
                });
            }
            return array;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PlaceholderProvider.prototype, "changedEvent", {
        get: function () {
            return this._placeholderManager.changedEvent;
        },
        enumerable: true,
        configurable: true
    });
    PlaceholderProvider.prototype._tryInitialize = function () {
        if (this._placeholders) {
            return true;
        }
        if (this._placeholderManager && this._placeholderManager.placeholders) {
            this._placeholders = new Map();
            for (var _i = 0, _a = this._placeholderManager.placeholders; _i < _a.length; _i++) {
                var placeholder = _a[_i];
                this._placeholders.set(placeholder.name, placeholder);
            }
            return true;
        }
        return false;
    };
    PlaceholderProvider._logSource = _LogSource.create('PlaceholderProvider');
    return PlaceholderProvider;
}());
export default PlaceholderProvider;
