import { Guid, Session, Validate, _SPEventManager, _SPKillSwitch } from '@microsoft/sp-core-library';
import { _Diagnostics } from '@microsoft/sp-diagnostics';
import { SPComponentLoader, _SPLoaderFlights } from '@microsoft/sp-loader';
import { PageContext, SharePointPageContextDataProvider } from '@microsoft/sp-page-context';
import { _Telemetry } from '@ms/sp-telemetry';
import ApplicationManager from '../ApplicationManager';
import BaseApplication from '../BaseApplication';
import { LOAD_EXTENSIONS_IN_PLACE_NAV } from '../extensibility/ApplicationCustomizerLoader';
import SPPageChrome from '../pageChrome/SPPageChrome';
import SPThemeProvider from '../pageChrome/SPThemeProvider';
var NavigationOrchestrator = (function () {
    function NavigationOrchestrator(serviceScope, applicationManager, navigator) {
        Validate.isNotNullOrUndefined(serviceScope, 'serviceScope');
        this._serviceScope = serviceScope;
        this._applicationManager = applicationManager || new ApplicationManager(serviceScope, navigator);
        this._pageContext = serviceScope.consume(PageContext.serviceKey);
    }
    NavigationOrchestrator.raiseNavigatedEvent = function () {
        _SPEventManager.instance.raiseStickyEvent(BaseApplication._navigatedEventName, {});
    };
    NavigationOrchestrator.prototype.navigate = function (preloadedData) {
        this._fixPreloadedDataItem(preloadedData);
        var isCrossSite = this._isCrossSite(preloadedData, this._pageContext);
        this._pageContext.initialize(SharePointPageContextDataProvider._createPageContextData(preloadedData.spPageContextInfo), preloadedData.spPageContextInfo);
        SPComponentLoader.registerManifests(preloadedData.manifests);
        if (_SPKillSwitch.isActivated(LOAD_EXTENSIONS_IN_PLACE_NAV, '2018/2/21', 'Load extensions on a cross-site in-place nav')) {
            if (isCrossSite && preloadedData.customActions && preloadedData.customActions.length) {
                throw new Error('Cross-site in-place navigation not supported with custom actions');
            }
        }
        else {
            if (!ApplicationManager._isChromelessApplication(preloadedData.clientSideApplicationId)) {
                SPPageChrome.getInstance(this._serviceScope);
            }
            this._applicationManager._loadApplicationCustomizers(preloadedData);
        }
        if (isCrossSite) {
            if (!ApplicationManager._isChromelessApplication(preloadedData.clientSideApplicationId)) {
                var themeProvider = new SPThemeProvider(this._serviceScope);
                themeProvider.loadThemedStyles();
            }
            _Telemetry.updateSettings({
                siteId: this._pageContext.legacyPageContext.siteId,
                webId: this._pageContext.legacyPageContext.webId
            });
            _Diagnostics.updateSettings({
                siteId: this._pageContext.legacyPageContext.siteId,
                webId: this._pageContext.legacyPageContext.webId
            });
        }
        preloadedData.spPageContextInfo = undefined;
        Session._changePage();
        NavigationOrchestrator.raiseNavigatedEvent();
        if (_SPLoaderFlights._useNewBootSequence()) {
            return this._applicationManager.startApplication(preloadedData).then(function (application) {
                return Promise.resolve({
                    preloadedData: preloadedData,
                    application: application
                });
            });
        }
        else {
            return Promise.resolve({
                preloadedData: preloadedData,
                application: undefined 
            });
        }
    };
    NavigationOrchestrator.prototype._isCrossSite = function (preloadedData, pageContext) {
        if (!pageContext.isInitialized) {
            return false;
        }
        return !Guid.parse(preloadedData.spPageContextInfo.webId).equals(pageContext.web.id) ||
            !Guid.parse(preloadedData.spPageContextInfo.siteId).equals(pageContext.site.id);
    };
    NavigationOrchestrator.prototype._fixPreloadedDataItem = function (preloadedData) {
        var INVALID_PAGE_ITEM_ID = -1;
        if (preloadedData.spPageContextInfo.pageItemId === INVALID_PAGE_ITEM_ID &&
            preloadedData.item &&
            preloadedData.item.ID !== INVALID_PAGE_ITEM_ID) {
            preloadedData.spPageContextInfo.pageItemId = preloadedData.item.ID;
        }
        return preloadedData;
    };
    return NavigationOrchestrator;
}());
export default NavigationOrchestrator;
